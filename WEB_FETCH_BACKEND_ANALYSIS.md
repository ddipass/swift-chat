# Web FetchåŠŸèƒ½è¿ç§»åˆ°Backendçš„åˆ†æ

## å½“å‰æ¶æ„åˆ†æ

### 1. SwiftChatæ•´ä½“æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    React Native App                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
â”‚  â”‚  Built-in    â”‚  â”‚     MCP      â”‚  â”‚  Perplexity  â”‚      â”‚
â”‚  â”‚    Tools     â”‚  â”‚    Tools     â”‚  â”‚    Tools     â”‚      â”‚
â”‚  â”‚ (web_fetch)  â”‚  â”‚              â”‚  â”‚              â”‚      â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚
â”‚         â”‚                  â”‚                  â”‚              â”‚
â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â”‚
â”‚                            â”‚                                 â”‚
â”‚                    â”Œâ”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”                        â”‚
â”‚                    â”‚  Claude Model  â”‚                        â”‚
â”‚                    â”‚  (Tool Calling)â”‚                        â”‚
â”‚                    â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜                        â”‚
â”‚                            â”‚                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚  Backend Server â”‚
                    â”‚   (FastAPI)     â”‚
                    â”‚                 â”‚
                    â”‚  /api/converse  â”‚
                    â”‚  /api/image     â”‚
                    â”‚  /api/models    â”‚
                    â”‚  /api/upgrade   â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚ Amazon Bedrock  â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2. å½“å‰web_fetchå®ç°ä½ç½®

**æ–‡ä»¶:** `react-native/src/mcp/BuiltInTools.ts`

**æ‰§è¡Œä½ç½®:** å®¢æˆ·ç«¯ï¼ˆReact Native Appï¼‰

**å·¥ä½œæµç¨‹:**
```
1. Claudeè°ƒç”¨web_fetchå·¥å…·
2. React Nativeæ‰§è¡Œfetch(url)
3. ä¸‹è½½HTMLå†…å®¹
4. å®¢æˆ·ç«¯å¤„ç†HTML:
   - Mode 1: Regexæ¸…ç†
   - Mode 2: AI Summary (è°ƒç”¨invokeBedrockWithCallBack)
5. è¿”å›å¤„ç†åçš„æ–‡æœ¬ç»™Claude
```

---

## æ˜¯å¦åº”è¯¥è¿ç§»åˆ°Backendï¼Ÿ

### âŒ **å»ºè®®ï¼šä¸åº”è¯¥è¿ç§»**

### ç†ç”±åˆ†æ

#### 1. **æ¶æ„è®¾è®¡åŸåˆ™**

SwiftChatçš„è®¾è®¡ç†å¿µæ˜¯ï¼š
- âœ… **éšç§ä¼˜å…ˆ** - æ•°æ®å°½å¯èƒ½åœ¨æœ¬åœ°å¤„ç†
- âœ… **å»ä¸­å¿ƒåŒ–** - å‡å°‘å¯¹backendçš„ä¾èµ–
- âœ… **å¯é€‰backend** - æ”¯æŒç›´æ¥ä½¿ç”¨Bedrock API Keyï¼Œå®Œå…¨ä¸éœ€è¦backend

**è¿ç§»åˆ°backendè¿èƒŒäº†è¿™äº›åŸåˆ™**

#### 2. **Backendçš„å®šä½**

æŸ¥çœ‹`server/README.md`å’Œ`server/src/main.py`ï¼Œbackendçš„èŒè´£æ˜¯ï¼š
- `/api/converse` - ä»£ç†Bedrock APIè°ƒç”¨
- `/api/image` - ä»£ç†å›¾ç‰‡ç”Ÿæˆ
- `/api/models` - è·å–æ¨¡å‹åˆ—è¡¨
- `/api/upgrade` - æ£€æŸ¥æ›´æ–°

**Backendæ˜¯ä¸€ä¸ªè½»é‡çº§çš„ä»£ç†å±‚ï¼Œä¸æ˜¯åŠŸèƒ½å¤„ç†å±‚**

#### 3. **å½“å‰å®ç°çš„ä¼˜åŠ¿**

**å®¢æˆ·ç«¯å®ç°çš„å¥½å¤„:**
- âœ… éšç§ä¿æŠ¤ - URLå’Œå†…å®¹ä¸ç»è¿‡backend
- âœ… æ€§èƒ½å¥½ - ç›´æ¥fetchï¼Œæ— éœ€é¢å¤–ç½‘ç»œè·³è½¬
- âœ… çµæ´»æ€§ - ç”¨æˆ·å¯é…ç½®å¤„ç†æ¨¡å¼ï¼ˆregex/AIï¼‰
- âœ… ç¦»çº¿èƒ½åŠ› - ä¸ä¾èµ–backendå¯ç”¨æ€§
- âœ… æˆæœ¬ä½ - ä¸å¢åŠ backendè´Ÿè½½

**è¿ç§»åˆ°backendçš„é—®é¢˜:**
- âŒ éšç§é—®é¢˜ - æ‰€æœ‰URLéƒ½è¦ç»è¿‡backend
- âŒ æ€§èƒ½ä¸‹é™ - App â†’ Backend â†’ Target URL â†’ Backend â†’ App
- âŒ æˆæœ¬å¢åŠ  - Backendéœ€è¦å¤„ç†å¤§é‡HTMLä¸‹è½½å’Œå¤„ç†
- âŒ æ‰©å±•æ€§å·® - Backendæˆä¸ºç“¶é¢ˆ
- âŒ è¿èƒŒè®¾è®¡ - ç ´å"å¯é€‰backend"çš„ç†å¿µ

#### 4. **AI Summaryçš„å®ç°**

å½“å‰AI Summaryè°ƒç”¨`invokeBedrockWithCallBack`ï¼š
```typescript
// å®¢æˆ·ç«¯ç›´æ¥è°ƒç”¨Bedrock
invokeBedrockWithCallBack(
  messages,
  summaryModel,
  callback,
  ChatMode.TEXT,
  systemPrompt
);
```

è¿™ä¸ªè°ƒç”¨é“¾ï¼š
- å¦‚æœä½¿ç”¨**Bedrock API Key**: ç›´æ¥è°ƒç”¨Bedrockï¼Œä¸ç»è¿‡backend
- å¦‚æœä½¿ç”¨**SwiftChat Server**: é€šè¿‡backendä»£ç†åˆ°Bedrock

**æ— è®ºå“ªç§æ–¹å¼ï¼Œweb_fetchæœ¬èº«éƒ½åœ¨å®¢æˆ·ç«¯æ‰§è¡Œ**

#### 5. **ä¸MCP/Perplexityçš„ä¸€è‡´æ€§**

- **MCP Tools**: åœ¨å®¢æˆ·ç«¯æ‰§è¡Œï¼ˆè¿æ¥æœ¬åœ°MCPæœåŠ¡å™¨ï¼‰
- **Perplexity Tools**: åœ¨å®¢æˆ·ç«¯æ‰§è¡Œï¼ˆç›´æ¥è°ƒç”¨Perplexity APIï¼‰
- **web_fetch**: åœ¨å®¢æˆ·ç«¯æ‰§è¡Œ

**ä¿æŒä¸€è‡´æ€§ï¼Œæ‰€æœ‰å·¥å…·éƒ½åœ¨å®¢æˆ·ç«¯æ‰§è¡Œ**

---

## å¦‚æœä¸€å®šè¦è¿ç§»ï¼Œéœ€è¦åšä»€ä¹ˆï¼Ÿ

### æ–¹æ¡ˆA: å®Œå…¨è¿ç§»ï¼ˆä¸æ¨èï¼‰

```python
# server/src/main.py

@app.post("/api/web_fetch")
async def web_fetch(request: WebFetchRequest):
    # 1. ä¸‹è½½URLå†…å®¹
    html = await fetch_url(request.url)
    
    # 2. å¤„ç†HTML
    if request.mode == "regex":
        text = clean_html_regex(html)
    else:
        text = await ai_summary(html, request.model)
    
    # 3. è¿”å›ç»“æœ
    return {"text": text}
```

**é—®é¢˜:**
- æ‰€æœ‰URLéƒ½ç»è¿‡backendï¼ˆéšç§é—®é¢˜ï¼‰
- Backendéœ€è¦å¤„ç†å¤§é‡HTMLï¼ˆæˆæœ¬é—®é¢˜ï¼‰
- å¢åŠ å»¶è¿Ÿï¼ˆæ€§èƒ½é—®é¢˜ï¼‰

### æ–¹æ¡ˆB: æ··åˆæ¨¡å¼ï¼ˆå¯è€ƒè™‘ï¼‰

```typescript
// å®¢æˆ·ç«¯
if (url.startsWith('https://internal-api')) {
  // å†…éƒ¨APIï¼Œé€šè¿‡backendä»£ç†ï¼ˆé¿å…CORSï¼‰
  result = await backendFetch(url);
} else {
  // å…¬å¼€URLï¼Œå®¢æˆ·ç«¯ç›´æ¥fetch
  result = await clientFetch(url);
}
```

**é€‚ç”¨åœºæ™¯:**
- éœ€è¦ç»•è¿‡CORSé™åˆ¶
- éœ€è¦ä½¿ç”¨backendçš„IPåœ°å€
- éœ€è¦backendçš„è®¤è¯å‡­æ®

**ä½†SwiftChatç›®å‰æ²¡æœ‰è¿™äº›éœ€æ±‚**

---

## ç»“è®º

### âŒ ä¸åº”è¯¥è¿ç§»web_fetchåˆ°backend

**åŸå› :**
1. **è¿èƒŒè®¾è®¡ç†å¿µ** - SwiftChatå¼ºè°ƒéšç§å’Œå»ä¸­å¿ƒåŒ–
2. **ç ´åæ¶æ„ä¸€è‡´æ€§** - æ‰€æœ‰å·¥å…·éƒ½åœ¨å®¢æˆ·ç«¯æ‰§è¡Œ
3. **å¢åŠ æˆæœ¬å’Œå¤æ‚åº¦** - Backendè´Ÿè½½å¢åŠ ï¼Œæ€§èƒ½ä¸‹é™
4. **æ²¡æœ‰å®é™…æ”¶ç›Š** - å½“å‰å®ç°å·²ç»å¾ˆå¥½

### âœ… å½“å‰å®ç°æ˜¯æœ€ä¼˜çš„

**ä¼˜åŠ¿:**
- éšç§ä¿æŠ¤
- æ€§èƒ½æœ€ä½³
- æˆæœ¬æœ€ä½
- æ¶æ„ç®€æ´
- çµæ´»å¯é…ç½®

### ğŸ“‹ å»ºè®®

**ä¿æŒç°çŠ¶ï¼Œç»§ç»­ä¼˜åŒ–å®¢æˆ·ç«¯å®ç°:**
1. âœ… å·²æœ‰debugä¿¡æ¯
2. âœ… å·²æœ‰AI summaryåŠŸèƒ½
3. âœ… å·²æœ‰regexæ¸…ç†åŠŸèƒ½
4. âœ… å·²æœ‰è¶…æ—¶æ§åˆ¶
5. âœ… å·²æœ‰é”™è¯¯å¤„ç†

**å¯ä»¥è€ƒè™‘çš„æ”¹è¿›:**
- æ·»åŠ ç¼“å­˜æœºåˆ¶ï¼ˆå®¢æˆ·ç«¯ç¼“å­˜å·²è®¿é—®çš„URLï¼‰
- æ·»åŠ æ›´å¤šHTMLæ¸…ç†é€‰é¡¹
- ä¼˜åŒ–AI summaryçš„prompt
- æ”¯æŒæ›´å¤šå†…å®¹ç±»å‹ï¼ˆPDFã€JSONç­‰ï¼‰

**ä½†è¿™äº›éƒ½åº”è¯¥åœ¨å®¢æˆ·ç«¯å®ç°ï¼Œä¸éœ€è¦backendå‚ä¸**

---

## ç‰¹æ®Šæƒ…å†µï¼šä»€ä¹ˆæ—¶å€™éœ€è¦backendï¼Ÿ

åªæœ‰ä»¥ä¸‹æƒ…å†µæ‰è€ƒè™‘backendå‚ä¸ï¼š

1. **CORSé™åˆ¶** - æŸäº›APIä¸å…è®¸æµè§ˆå™¨ç›´æ¥è®¿é—®
   - è§£å†³æ–¹æ¡ˆï¼šä½¿ç”¨CORSä»£ç†ï¼Œè€Œä¸æ˜¯å®Œæ•´çš„fetchåŠŸèƒ½

2. **è®¤è¯éœ€æ±‚** - éœ€è¦backendçš„å‡­æ®
   - è§£å†³æ–¹æ¡ˆï¼šbackendåªæä¾›è®¤è¯tokenï¼Œfetchä»åœ¨å®¢æˆ·ç«¯

3. **IPé™åˆ¶** - æŸäº›æœåŠ¡é™åˆ¶å®¢æˆ·ç«¯IP
   - è§£å†³æ–¹æ¡ˆï¼šbackendæä¾›ä»£ç†ç«¯ç‚¹ï¼Œä½†è¿™æ˜¯ç‰¹ä¾‹

4. **åˆè§„è¦æ±‚** - éœ€è¦è®°å½•æ‰€æœ‰è®¿é—®
   - è§£å†³æ–¹æ¡ˆï¼šå®¢æˆ·ç«¯å‘é€æ—¥å¿—ï¼Œè€Œä¸æ˜¯è¿ç§»åŠŸèƒ½

**SwiftChatç›®å‰æ²¡æœ‰è¿™äº›éœ€æ±‚ï¼Œæ‰€ä»¥ä¸éœ€è¦backendå‚ä¸**

---

## æ€»ç»“

| ç»´åº¦ | å®¢æˆ·ç«¯å®ç° | Backendå®ç° |
|------|-----------|------------|
| éšç§ä¿æŠ¤ | âœ… ä¼˜ç§€ | âŒ å·® |
| æ€§èƒ½ | âœ… æœ€ä½³ | âŒ è¾ƒå·® |
| æˆæœ¬ | âœ… æœ€ä½ | âŒ è¾ƒé«˜ |
| æ¶æ„ä¸€è‡´æ€§ | âœ… ä¸€è‡´ | âŒ ä¸ä¸€è‡´ |
| çµæ´»æ€§ | âœ… é«˜ | âŒ ä½ |
| ç¦»çº¿èƒ½åŠ› | âœ… æ”¯æŒ | âŒ ä¸æ”¯æŒ |
| å®ç°å¤æ‚åº¦ | âœ… ç®€å• | âŒ å¤æ‚ |

**ç»“è®º: ä¿æŒweb_fetchåœ¨å®¢æˆ·ç«¯å®ç°æ˜¯æœ€ä½³é€‰æ‹©**
