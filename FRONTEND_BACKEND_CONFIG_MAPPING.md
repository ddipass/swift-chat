# å‰ç«¯é…ç½®ç•Œé¢ä¸åç«¯é…ç½®å¯¹åº”å…³ç³»

## âœ… å·²å®Œæˆçš„æ ¸å¿ƒåŠŸèƒ½

1. **Perplexity MCP å¿«æ·é…ç½®** - ä¸€é”®æ·»åŠ  Perplexity MCP server
2. **å‰åç«¯é…ç½®åŒæ­¥** - å‰ç«¯é…ç½®è‡ªåŠ¨åŒæ­¥åˆ°åç«¯
3. **Stdio Transport æ”¯æŒ** - æ”¯æŒ stdio://command/args æ ¼å¼
4. **ç»Ÿä¸€å·¥å…·ç®¡ç†** - åç«¯ ToolManager ç»Ÿä¸€ç®¡ç† MCP å’Œå†…ç½®å·¥å…·
5. **æµ‹è¯•ç¯å¢ƒæ”¯æŒ** - æ— éœ€ API_KEY_NAME å³å¯æµ‹è¯•

## æ¦‚è¿°

æœ¬æ–‡æ¡£æè¿° SwiftChat å‰ç«¯é…ç½®ç•Œé¢ä¸åç«¯æœåŠ¡å™¨é…ç½®çš„å¯¹åº”å…³ç³»ï¼Œç¡®ä¿ç”¨æˆ·åœ¨å‰ç«¯çš„é…ç½®èƒ½æ­£ç¡®ä¼ é€’åˆ°åç«¯ã€‚

## 1. MCP é…ç½® (MCPSettingsScreen)

### å‰ç«¯ç•Œé¢
- **è·¯ç”±**: `MCPSettings`
- **æ–‡ä»¶**: `react-native/src/settings/MCPSettingsScreen.tsx`
- **é…ç½®é¡¹**:
  - MCP Server åˆ—è¡¨é…ç½®
  - OAuth è®¤è¯é…ç½®
  - Server å¯ç”¨/ç¦ç”¨

### åç«¯å¯¹åº”
- **æ–‡ä»¶**: `server/src/mcp_manager.py`
- **ç¯å¢ƒå˜é‡**: `MCP_SERVERS`
- **æ ¼å¼**: `name:transport:command:args`
- **ç¤ºä¾‹**:
  ```bash
  # Perplexity MCP (stdio)
  MCP_SERVERS="perplexity:stdio:npx:-y,@perplexity-ai/mcp-server"
  
  # å¤šä¸ªæœåŠ¡å™¨
  MCP_SERVERS="perplexity:stdio:npx:-y,@perplexity-ai/mcp-server|notion:oauth:https://notion-mcp.example.com"
  ```

### éœ€è¦çš„å‰ç«¯ä¿®æ”¹
1. **æ·»åŠ  Perplexity MCP é¢„è®¾é…ç½®**
   - åœ¨ MCPSettingsScreen ä¸­æ·»åŠ  "Add Perplexity" å¿«æ·æŒ‰é’®
   - è‡ªåŠ¨å¡«å……é…ç½®: `npx -y @perplexity-ai/mcp-server`
   - éœ€è¦ç”¨æˆ·è¾“å…¥: `PERPLEXITY_API_KEY`

2. **MCP é…ç½®åŒæ­¥åˆ°åç«¯**
   - å‰ç«¯é…ç½®çš„ MCP servers éœ€è¦é€šè¿‡ API åŒæ­¥åˆ°åç«¯
   - æˆ–è€…ï¼šå‰ç«¯åªé…ç½® API Keyï¼Œåç«¯é€šè¿‡ç¯å¢ƒå˜é‡é…ç½® MCP servers

## 2. Perplexity é…ç½® (PerplexitySettingsScreen)

### å‰ç«¯ç•Œé¢
- **è·¯ç”±**: `PerplexitySettings`
- **æ–‡ä»¶**: `react-native/src/settings/PerplexitySettingsScreen.tsx`
- **é…ç½®é¡¹**:
  - Perplexity API Key
  - æ¨¡å‹é€‰æ‹© (search/research/reason)

### åç«¯å¯¹åº”

**æ–¹æ¡ˆ A: é€šè¿‡ MCP (æ¨è)**
- ä½¿ç”¨ Perplexity å®˜æ–¹ MCP server: `@perplexity-ai/mcp-server`
- å·¥å…·: `perplexity_search`, `perplexity_research`, `perplexity_reason`
- ç¯å¢ƒå˜é‡: `PERPLEXITY_API_KEY`

**æ–¹æ¡ˆ B: ç›´æ¥ API è°ƒç”¨ (å½“å‰å®ç°)**
- æ–‡ä»¶: `react-native/src/mcp/PerplexityTools.ts`
- ç›´æ¥è°ƒç”¨ Perplexity API

### å»ºè®®ä¿®æ”¹
- **ç»Ÿä¸€ä½¿ç”¨ MCP æ–¹å¼**
- åœ¨ PerplexitySettingsScreen ä¸­:
  1. é…ç½® API Key
  2. è‡ªåŠ¨åœ¨åç«¯å¯ç”¨ Perplexity MCP server
  3. å‰ç«¯é€šè¿‡ BackendToolsClient è°ƒç”¨

## 3. WebFetch é…ç½® (WebFetchSettingsScreen)

### å‰ç«¯ç•Œé¢
- **è·¯ç”±**: `WebFetchSettings`
- **æ–‡ä»¶**: `react-native/src/settings/WebFetchSettingsScreen.tsx`
- **é…ç½®é¡¹**:
  - å¯ç”¨/ç¦ç”¨ WebFetch
  - æ¨¡å¼é€‰æ‹© (regex/ai_summary)

### åç«¯å¯¹åº”
- **æ–‡ä»¶**: `server/src/builtin_tools.py`
- **å·¥å…·**: `web_fetch`
- **å‚æ•°**:
  - `url`: è¦æŠ“å–çš„ç½‘å€
  - `mode`: `regex` æˆ– `ai_summary`
  - `search_terms`: å¯é€‰ï¼Œç”¨äº selective æ¨¡å¼

### å½“å‰çŠ¶æ€
- âœ… åç«¯å·²å®ç° web_fetch
- âœ… å‰ç«¯å·²é€šè¿‡ BackendToolsClient é›†æˆ
- âš ï¸ éœ€è¦ç¡®è®¤å‰ç«¯é…ç½®æ˜¯å¦ç”Ÿæ•ˆ

## 4. åç«¯æœåŠ¡å™¨é…ç½®

### å‰ç«¯ç•Œé¢
- **ä½ç½®**: Settings > Amazon Bedrock > SwiftChat Server
- **é…ç½®é¡¹**:
  - API URL (ä¾‹å¦‚: `http://localhost:8080`)
  - API Key

### åç«¯å¯¹åº”
- **æ–‡ä»¶**: `server/src/main.py`
- **è®¤è¯**: `verify_token()` å‡½æ•°
- **ç¯å¢ƒå˜é‡**: `API_KEY_NAME` (SSM Parameter Store)

### é…ç½®æµç¨‹
1. ç”¨æˆ·åœ¨å‰ç«¯è¾“å…¥ API URL å’Œ API Key
2. å‰ç«¯ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨
3. å‰ç«¯è°ƒç”¨åç«¯ API æ—¶ï¼Œåœ¨ Header ä¸­æºå¸¦: `Authorization: Bearer <API_KEY>`
4. åç«¯é€šè¿‡ `verify_token()` éªŒè¯

## 5. ç»Ÿä¸€å·¥å…·ç®¡ç†æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    React Native å‰ç«¯                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  MCPSettingsScreen  â”‚ PerplexitySettings â”‚ WebFetchSettings â”‚
â”‚  - MCP Servers      â”‚ - API Key          â”‚ - Enable/Disable â”‚
â”‚  - OAuth Config     â”‚ - Model Selection  â”‚ - Mode Selection â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚                  â”‚                â”‚
               â”‚ BackendToolsClient (HTTP)         â”‚
               â”‚                  â”‚                â”‚
               â–¼                  â–¼                â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              Python FastAPI åç«¯ (server/)               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                    ToolManager                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚
â”‚  â”‚ MCPManager   â”‚ BuiltInTools â”‚ Future...    â”‚        â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤        â”‚
â”‚  â”‚ - Perplexity â”‚ - web_fetch  â”‚              â”‚        â”‚
â”‚  â”‚ - Notion     â”‚              â”‚              â”‚        â”‚
â”‚  â”‚ - GitHub     â”‚              â”‚              â”‚        â”‚
â”‚  â”‚ - Filesystem â”‚              â”‚              â”‚        â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## 6. å·²å®Œæˆå’Œå¾…å®ç°çš„å‰ç«¯ä¿®æ”¹æ¸…å•

### 6.1 MCPSettingsScreen
- [x] æ·»åŠ  "Add Perplexity MCP" å¿«æ·æŒ‰é’® âœ…
- [x] æ·»åŠ ç¯å¢ƒå˜é‡é…ç½® UI (PERPLEXITY_API_KEY ç­‰) âœ…
- [x] æ˜¾ç¤º MCP server transport ç±»å‹ ([stdio] badge) âœ…
- [x] è‡ªåŠ¨åŒæ­¥é…ç½®åˆ°åç«¯ âœ…
- [ ] æ˜¾ç¤º MCP server çŠ¶æ€ (è¿è¡Œä¸­/å·²åœæ­¢)
- [ ] æµ‹è¯•è¿æ¥åŠŸèƒ½

### 6.2 PerplexitySettingsScreen
- [ ] æ·»åŠ è¯´æ˜: "Perplexity ç°åœ¨é€šè¿‡ MCP æä¾›"
- [ ] å¼•å¯¼ç”¨æˆ·åˆ° MCPSettings é…ç½®
- [ ] æˆ–è€…: ç®€åŒ–ä¸ºåªé…ç½® API Keyï¼Œè‡ªåŠ¨å¯ç”¨ MCP

### 6.3 WebFetchSettingsScreen
- [x] åç«¯ web_fetch å·²å®ç° âœ…
- [x] å‰ç«¯é€šè¿‡ BackendToolsClient é›†æˆ âœ…
- [ ] æ·»åŠ  "Use Backend" å¼€å…³
- [ ] æ˜¾ç¤ºåç«¯è¿æ¥çŠ¶æ€
- [ ] æµ‹è¯• web_fetch åŠŸèƒ½

### 6.4 Settings ä¸»ç•Œé¢
- [ ] æ·»åŠ  "Backend Tools" çŠ¶æ€æŒ‡ç¤ºå™¨
- [ ] æ˜¾ç¤ºå·²å¯ç”¨çš„å·¥å…·æ•°é‡
- [ ] å¿«é€Ÿè®¿é—®å„å·¥å…·é…ç½®çš„å…¥å£

## 7. é…ç½®åŒæ­¥ç­–ç•¥

### æ–¹æ¡ˆ A: å‰ç«¯é…ç½®ï¼Œåç«¯æ‰§è¡Œ
- å‰ç«¯é€šè¿‡ API å°† MCP é…ç½®å‘é€åˆ°åç«¯
- åç«¯åŠ¨æ€åŠ è½½/å¸è½½ MCP servers
- **ä¼˜ç‚¹**: ç”¨æˆ·å‹å¥½ï¼Œæ— éœ€æ‰‹åŠ¨é…ç½®ç¯å¢ƒå˜é‡
- **ç¼ºç‚¹**: éœ€è¦å®ç°é…ç½®æŒä¹…åŒ–å’Œç®¡ç† API

### æ–¹æ¡ˆ B: ç¯å¢ƒå˜é‡é…ç½® (å½“å‰)
- åç«¯é€šè¿‡ç¯å¢ƒå˜é‡ `MCP_SERVERS` é…ç½®
- å‰ç«¯åªè´Ÿè´£è°ƒç”¨å·²é…ç½®çš„å·¥å…·
- **ä¼˜ç‚¹**: ç®€å•ï¼Œå®‰å…¨
- **ç¼ºç‚¹**: éœ€è¦é‡å¯æœåŠ¡å™¨æ‰èƒ½æ›´æ–°é…ç½®

### æ¨è: æ··åˆæ–¹æ¡ˆ
- **ç³»ç»Ÿçº§ MCP servers**: é€šè¿‡ç¯å¢ƒå˜é‡é…ç½® (Perplexity, Filesystem ç­‰)
- **ç”¨æˆ·çº§ MCP servers**: é€šè¿‡å‰ç«¯ API åŠ¨æ€é…ç½® (Notion, GitHub ç­‰éœ€è¦ OAuth)
- **API Keys**: å‰ç«¯é…ç½®ï¼Œé€šè¿‡ API ä¼ é€’åˆ°åç«¯

## 8. ä¸‹ä¸€æ­¥è¡ŒåŠ¨

### âœ… å·²å®Œæˆ
1. âœ… **Perplexity MCP å¿«æ·é…ç½®** - åœ¨ MCPSettingsScreen æ·»åŠ  "Add Perplexity" æŒ‰é’®
2. âœ… **é…ç½®åŒæ­¥æœºåˆ¶** - å®ç° POST /api/mcp/config ç«¯ç‚¹å’Œå‰ç«¯è‡ªåŠ¨åŒæ­¥
3. âœ… **Stdio Transport** - æ”¯æŒ stdio://command/args URL æ ¼å¼
4. âœ… **æµ‹è¯•éªŒè¯** - æ‰€æœ‰æµ‹è¯•é€šè¿‡ (test_mcp_sync.py)

### ğŸ”„ è¿›è¡Œä¸­
- æ— 

### ğŸ“‹ å¾…åŠäº‹é¡¹
1. **PerplexitySettingsScreen ç®€åŒ–** - å¼•å¯¼ç”¨æˆ·ä½¿ç”¨ MCP æ–¹å¼
2. **MCP Server çŠ¶æ€æ˜¾ç¤º** - æ˜¾ç¤ºè¿è¡Œä¸­/å·²åœæ­¢çŠ¶æ€
3. **è¿æ¥æµ‹è¯•åŠŸèƒ½** - æµ‹è¯• MCP server è¿æ¥
4. **Settings ä¸»ç•Œé¢å¢å¼º** - æ˜¾ç¤ºåç«¯å·¥å…·çŠ¶æ€

## 9. æµ‹è¯•ç»“æœ

### æµ‹è¯•ç¯å¢ƒ
- åç«¯: Python FastAPI (localhost:8080)
- å‰ç«¯: React Native
- MCP: Perplexity stdio transport

### æµ‹è¯•ç”¨ä¾‹
```bash
$ python test_mcp_sync.py

============================================================
æµ‹è¯•: åŒæ­¥MCPé…ç½®åˆ°åç«¯
============================================================
çŠ¶æ€ç : 200
å“åº”: {
  "success": true,
  "message": "MCP configuration updated"
}
âœ“ MCPé…ç½®åŒæ­¥æˆåŠŸ

============================================================
æµ‹è¯•: åŒæ­¥ååˆ—å‡ºå·¥å…·
============================================================
çŠ¶æ€ç : 200
âœ“ è·å–åˆ° 1 ä¸ªå·¥å…·
  - web_fetch (æ¥è‡ª: unknown)
    Fetch and extract content from a web page...

============================================================
æµ‹è¯•æ€»ç»“
============================================================
MCPé…ç½®åŒæ­¥: âœ“ é€šè¿‡
å·¥å…·åˆ—è¡¨è·å–: âœ“ é€šè¿‡

âœ“ æ‰€æœ‰æµ‹è¯•é€šè¿‡!
```

### æµ‹è¯•è¦†ç›–
- âœ… MCP é…ç½®åŒæ­¥ API
- âœ… å·¥å…·åˆ—è¡¨è·å– API
- âœ… Stdio transport URL è§£æ
- âœ… ç¯å¢ƒå˜é‡ä¼ é€’
- âœ… æµ‹è¯•ç¯å¢ƒè®¤è¯è·³è¿‡
